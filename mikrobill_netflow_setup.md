# Настройка сбора в MikroBILL NetFlow v5 экспорта с Debian (softflowd)

Эта инструкция описывает, как настроить экспорт NetFlow с сервера **Debian/Ubuntu** с помощью `softflowd` и подключить коллектор в **MikroBILL**. IP‑адреса в примерах заменены на обезличенные из диапазонов RFC5737.

---

## Схема и обозначения

- **Экспортёр NetFlow (Debian):** интерфейс захвата трафика — `br-ipcam`  
- **Коллектор NetFlow (MikroBILL):** `198.51.100.6:1239/udp`  
- **Локальный адрес экспортёра для исходящих пакетов NetFlow:** `198.51.100.9`  
- **Вспомогательный интерфейс для статистики:** `enp2s0.10`  
- **Версия NetFlow:** v5  
- **База для NetFlow:** `mikrobill_netflow` на отдельном MySQL‑сервере

> При необходимости замените интерфейсы и IP на свои.

---

## 1) Установка и базовая настройка softflowd на Debian

```bash
sudo apt update
sudo apt install -y softflowd
```

### Запуск с параметрами (вариант через systemd override)

Создадим drop-in для переопределения параметров запуска службы:

```bash
sudo systemctl edit softflowd.service
```

В открывшемся редакторе вставьте:

```ini
[Service]
ExecStart=
ExecStart=/usr/sbin/softflowd \
  -i br-ipcam \
  -n 198.51.100.6:1239 \
  -v 5 \
  -t expint=10 -t udp=15 -t tcp=30 -t general=60 \
  -S enp2s0.10 \
  -e 198.51.100.9 \
  -B 4194304
```

Примените изменения и запустите службу:

```bash
sudo systemctl daemon-reload
sudo systemctl enable --now softflowd
sudo systemctl status softflowd --no-pager
```

#### Пояснение ключей
- `-i br-ipcam` — интерфейс, с которого снимается потоковая статистика.
- `-n 198.51.100.6:1239` — адрес и UDP‑порт коллектора (MikroBILL).
- `-v 5` — экспорт в формате **NetFlow v5**.
- `-t expint=10` — интервал экспорта активных потоков, сек.
- `-t udp=15`, `-t tcp=30`, `-t general=60` — таймауты завершения потоков.
- `-S enp2s0.10` — интерфейс для счётчиков/косвенных метрик (опционально).
- `-e 198.51.100.9` — исходный IP в NetFlow пакетах (адрес экспортёра).
- `-B 4194304` — размер буфера при высоких нагрузках (в байтах).

> **Примечание:** альтернативно можно задать параметры в `/etc/default/softflowd` (директива `OPTIONS="..."`).

---

## 2) Создание базы MySQL для NetFlow

> Если NetFlow хранится на отдельном MySQL‑сервере — выполните команды на нём.

```sql
CREATE DATABASE mikrobill_netflow
  CHARACTER SET utf8mb4
  COLLATE utf8mb4_unicode_ci;

CREATE USER 'netflow_user'@'%' IDENTIFIED BY 'strong_password_here';

GRANT ALL PRIVILEGES ON mikrobill_netflow.* TO 'netflow_user'@'%';
FLUSH PRIVILEGES;
```

> Рекомендуется ограничить доступ по сети (firewall), шифровать соединение и/или использовать `mysql_native_password`/`caching_sha2_password` согласно вашей версии MySQL.

---

## 3) Настройка базы адресов в MikroBILL

Откройте: **Настройка → Программа → База данных**

- **Первая строка (Адрес MySQL):** параметры подключения к **основной базе MikroBILL** (где хранится сам MikroBILL).  
- **Вторая строка (Адрес MySQL NetFlow):** параметры подключения к **серверу MySQL с NetFlow** (`mikrobill_netflow`).

Проверьте соединение для обеих строк.

---

## 4) Добавление роутера и включение приёма NetFlow в MikroBILL

Откройте: **Администрирование → Роутеры и настройки**

1. Нажмите «Создать роутер».
2. **Тип:** `Linux`  
3. Заполните: **адрес**, **логин**, **пароль**, **порт SSH** (для проверки доступности).
4. Поставьте галочку **«Сбор NetFlow / Сохранить в БД сетевую активность»**.  
   - В этом окне MikroBILL покажет **UDP‑порт** для входящих NetFlow (например, `1239`).  
5. Сохраните роутер и убедитесь, что статус соединения «ОК».

> Убедитесь, что на сервере с MikroBILL открыт соответствующий UDP‑порт (например, `1239/udp`) и корректно настроен брандмауэр/NAT.

---

## 5) Создание тарифов и групп (пример)

Откройте: **Администрирование → Тарифы / Группы**  
- Создайте тарифы по вашей политике биллинга.  
- Создайте группу, например: **«Сервис видеонаблюдения»**.  
- Привяжите абонентов к нужным тарифам/группам.

---

## 6) Настройка MySQL Web для записи NetFlow

Откройте: **MySQL Web** → найдите запись **«Параметры записи NetFlow в БД»** → «Изменить». Укажите:

- **Адрес MySQL сервера** (где расположен `mikrobill_netflow`)
- **Порт**
- **Имя БД:** `mikrobill_netflow`
- **Логин/пароль**: `netflow_user` / `strong_password_here`

Нажмите **«Проверить соединение с базой данных»** — статус должен быть «успешно».

### Параметры производительности и хранения
- **Удалять через, мес.:** `1` (пример автоматического удаления старше 1 месяца)
- **Размер кэша, МБ:** `2048`
- **SQL‑пакет, КБ:** `1024`

Сохраните настройки.

---

## 7) Верификация в интерфейсе MikroBILL

У абонента откройте вкладку: **«Сетевая активность»** → нажмите **«Обновить»** → выберите период, например **«За последний час»**.  
Должны отобразиться записи из таблиц NetFlow за выбранный интервал.

---

## 8) Контроль и отладка

### Проверка поступления потоков на коллектор
На сервере с MikroBILL (если доступен `tcpdump`):
```bash
sudo tcpdump -nni any udp port 1239
```
Должны видны пакеты от `198.51.100.9` на `198.51.100.6:1239`.

### Диагностика softflowd
```bash
sudo systemctl status softflowd --no-pager
sudo journalctl -u softflowd -e
```

### Частые причины отсутствия данных
1. Неверный интерфейс `-i` на экспортёре — нет зеркала/трафика на `br-ipcam`.
2. Брандмауэр/маршрутизация/НАТ блокируют `UDP/1239`.
3. Версия экспорта не совпадает (настроен v5, а коллектор ждёт другую версию).
4. Ошибка в параметрах подключения к `mikrobill_netflow`.
5. Недостаточно прав у MySQL‑пользователя или переполнен диск/квота.

---

## 9) Рекомендации по производительности и надёжности

- Для загруженных сетей увеличьте буфер `-B` (например, до `8–16 MiB`) и уменьшите `expint` для более частого экспорта.
- Следите за здоровьем MySQL (`slow_query_log`, индексы, ротация, репликация при необходимости).
- Включите мониторинг задержек записи NetFlow и заполнения кэша.
- Ограничьте доступ к MySQL по сети (ACL/firewall) и используйте отдельного пользователя, роль и отдельный хост для NetFlow.
- Применяйте резервное копирование БД NetFlow c удержанием, согласованным с политикой хранения данных.

---

## 10) Быстрый чек‑лист

- [ ] `softflowd` установлен и запущен, версия v5, адрес коллектора и порт указаны верно.  
- [ ] UDP‑порт на стороне MikroBILL открыт, пакеты доходят.  
- [ ] БД `mikrobill_netflow` создана, учётка и права выданы, соединение из MikroBILL успешно.  
- [ ] У роутера в MikroBILL включён «Сбор NetFlow / Сохранить в БД сетевую активность».  
- [ ] В «Сетевой активности» абонента появляются записи за выбранный период.

---

### Пример полной строки запуска softflowd (с обезличенными IP)
```bash
/usr/sbin/softflowd -i br-ipcam -n 198.51.100.6:1239 -v 5 \
  -t expint=10 -t udp=15 -t tcp=30 -t general=60 \
  -S enp2s0.10 -e 198.51.100.9 -B 4194304
```

Готово: после выполнения шагов данные NetFlow будут собираться `softflowd`, приниматься коллекторами MikroBILL и записываться в выделенную базу `mikrobill_netflow` для дальнейшего анализа и биллинга.
