
# Опыт использования **mergerfs** как программного объединителя дисков без RAID

## Введение

При проектировании домашних или лабораторных серверов нередко возникает ситуация, когда нужно объединить несколько дисков в одно логическое хранилище, но при этом нет необходимости или возможности собирать RAID-массив.
В моём случае требовалось создать хранилище для видеофайлов на двух дисках по 1 ГБ каждый. Я решил протестировать **mergerfs** — FUSE-надстройку, объединяющую несколько файловых систем в одну.

---

## Цель

Проверить, насколько **mergerfs** подходит для:

* объединения независимых дисков без RAID;
* равномерного распределения файлов по дискам;
* восстановления структуры данных при временном отключении одного из носителей.

---

## Настройка дисков и монтирование

### 1. Подготовка файловых систем

Оба диска (`/dev/sda` и `/dev/sdc`) были отформатированы в **XFS** и подключены по UUID:

```bash
/dev/sda: UUID="32e47474-b407-46cb-a099-f3548364dd4f" TYPE="xfs"
/dev/sdc: UUID="c5f72477-7948-42db-ae6b-9abe5d8e51b9" TYPE="xfs"
```

Созданы каталоги для монтирования:

```bash
mkdir -p /mnt/d1 /mnt/d2 /mnt/merged
```

---

### 2. Настройка `/etc/fstab`

Ниже приведён фрагмент моего **fstab**:

```fstab
# Диск d1 по UUID
UUID=32e47474-b407-46cb-a099-f3548364dd4f  /mnt/d1  xfs  defaults,nofail  0  0
# Диск d2 по UUID
UUID=c5f72477-7948-42db-ae6b-9abe5d8e51b9  /mnt/d2  xfs  defaults,nofail  0  0

# Объединённый каталог mergerfs
/mnt/d1:/mnt/d2 /mnt/merged fuse.mergerfs defaults,allow_other,nofail,category.create=epmfs,minfreespace=10M,moveonenospc=true 0 0
```

Здесь используется режим `category.create=epmfs`, который создаёт новые файлы на разделе с **наибольшим свободным местом** (existing path, most free space).

---

## Проверка работы mergerfs

После монтирования система видела оба диска:

```bash
lsblk
NAME   MAJ:MIN RM  SIZE RO TYPE MOUNTPOINTS
sda      8:0    0    1G  0 disk /mnt/d1
sdb      8:16   0   32G  0 disk /
sdc      8:32   0    1G  0 disk /mnt/d2
```

---

## Тестирование распределения файлов

Для проверки я создал 20 файлов по 100 МБ каждый в объединённом каталоге `/mnt/merged`:

```bash
for i in $(seq 20 30); do
  fallocate -l 100M /mnt/merged/yucca_${i}.bin
done
```

Результаты:

```bash
user@debian:~$ ls /mnt/merged/
test          yucca_21.bin  yucca_25.bin  yucca_3.bin  yucca_7.bin
yucca_10.bin  yucca_22.bin  yucca_26.bin  yucca_4.bin  yucca_8.bin
yucca_1.bin   yucca_23.bin  yucca_27.bin  yucca_5.bin  yucca_9.bin
yucca_20.bin  yucca_24.bin  yucca_2.bin   yucca_6.bin
```

**Физически** файлы распределились примерно поровну:

```bash
# /mnt/d1
yucca_10.bin  yucca_23.bin  yucca_27.bin  yucca_4.bin  yucca_8.bin
yucca_21.bin  yucca_25.bin  yucca_2.bin   yucca_6.bin

# /mnt/d2
test          yucca_20.bin  yucca_24.bin  yucca_3.bin  yucca_7.bin
yucca_1.bin   yucca_22.bin  yucca_26.bin  yucca_5.bin  yucca_9.bin
```

---

## Проверка отказоустойчивости

Далее я **отключил один диск** (отсоединил от виртуальной машины).
Mergerfs продолжил работать с оставшимся — файлы с другого диска, естественно, были временно недоступны, но остальные открывались и копировались без ошибок.

После **возврата диска** в систему и повторного монтирования структура полностью восстановилась, никаких повреждений не произошло.

---

## Использование дискового пространства

```bash
df -h /mnt/merged/
Filesystem      Size  Used Avail Use% Mounted on
1:2             1.9G  1.9G   43M  98% /mnt/merged
```

Mergerfs отобразил совокупный объём обоих разделов — около **2 ГБ**, как и ожидалось.

---

## Выводы

Эксперимент показал, что:

1. **Mergerfs** действительно можно использовать как удобную альтернативу RAID-массивам в случаях, когда:

   * нет аппаратной поддержки RAID;
   * диски различного размера или формата;
   * важна простота замены и обслуживания.

2. Файлы **равномерно распределяются** между дисками, благодаря политике `epmfs`.

3. При **временном отключении** одного из дисков система продолжает работу, а после возврата — структура полностью восстанавливается без пересборки.

4. Подобный подход идеально подходит для:

   * хранения мультимедиа (видео, фото, архивов);
   * домашних NAS или небольших серверов;
   * случаев, когда важна простота, а не отказоустойчивость уровня RAID-1.

---

## Заключение

**Mergerfs** — это надёжный и гибкий инструмент, который может стать отличным решением для домашних и лабораторных систем.
Он не заменяет RAID, но даёт гибкость и простоту, при этом сохраняя данные на отдельных дисках, что облегчает их восстановление или перенос.

